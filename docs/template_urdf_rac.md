# Template URDF in RAvRAC (RAC)

This document explains:

1. What RAC means by a “template URDF”
2. What that URDF file contains
3. How `robot_rest-*.obj` is generated from it


## 1) What is the “template URDF” in RAC?

In RAC, the “template URDF” is the predefined skeleton you provide via `--pre_skel` (or a direct URDF path).  
The code resolves `--pre_skel` to a concrete URDF file (e.g., `mesh_material/wolf_mod_revised.urdf`) and loads it through `URDFRobot`.  

Relevant code:
- `nnutils/banmo.py` resolves `--pre_skel` to a URDF path and builds `URDFRobot`.  
- `nnutils/robot.py` loads the URDF into a `urdfpy.URDF` object and sets per‑template defaults.  

See:
- `nnutils/banmo.py:360` to `nnutils/banmo.py:384`
- `nnutils/robot.py:10` to `nnutils/robot.py:107`


## 2) What does the template URDF contain?

The URDF is a **standard robot description**, so it provides:

- **Links**: Named rigid bodies (e.g., `base_link`, `link_162_Oberschenkel_L_R`, etc.)
- **Joints**: Parent → child connectivity, joint type, axis, origin, and limits
- **Geometry**: Visual and/or collision meshes for each link
- **Joint origins**: The frame (transform) where a joint’s rotation/translation is applied

RAC uses these in a few ways:

### 2.1 URDF link/joint hierarchy (kinematic tree)
The URDF defines the full kinematic chain. Example (from `wolf_mod_revised.urdf`):

```
joint_162_Oberschenkel_L_R: parent base_link → child link_162_Oberschenkel_L_R
joint_162_Oberschenkel_L_P: parent link_162_Oberschenkel_L_R → child link_162_Oberschenkel_L_P
joint_162_Oberschenkel_L_Y: parent link_162_Oberschenkel_L_P → child link_162_Oberschenkel_L_Y
```

This is a **3‑DoF joint modeled as three serial revolute joints** (roll/pitch/yaw), which is common in URDF.

### 2.2 Joint centers and angles used in RAC
When the URDF is loaded, RAC extracts joint centers and joint name order:

- `get_joints()` gathers joint centers from `joint.origin` for training, and builds:
  - `urdf.name2joints_idx`
  - `urdf.name2query_idx`
  - `urdf.angle_names`

See:
- `nnutils/urdf_utils.py:60` to `nnutils/urdf_utils.py:99`

### 2.3 Template-specific defaults
`URDFRobot` sets:

- `urdf.ball_joint` (treats some templates as 3‑DoF joints)
- Default **Sim(3)** (`sim3`): canonical translation / rotation / scale
- Default `rest_angles`
- `urdf.kp_links` (keypoint links for some templates)

See:
- `nnutils/robot.py:15` to `nnutils/robot.py:103`


## 3) How does RAC generate `robot_rest` from the URDF?

The `robot_rest` mesh is generated by **articulating the URDF** at the model’s predicted **rest pose angles**.

### 3.1 Overview of the pipeline

1. **Predict rest pose angles** from the model  
   `visualize_joints()` calls `model.nerf_body_rts.forward_abs(...)` to get:
   - joint transforms
   - joint angles

2. **Convert angles → URDF config**  
   `angles2cfg()` maps each joint angle into a dict used by `urdfpy` FK.

3. **Articulate the URDF**  
   `articulate_robot()` calls `urdfpy` FK (`visual_trimesh_fk`) and applies each link transform to its mesh, returning a single concatenated mesh.

4. **Apply Sim(3) to canonical space**  
   The mesh is scaled, rotated, and translated by `sim3` (the template’s canonical transform).

5. **Export OBJ**  
   `robot_rest-*.obj` is saved from the resulting mesh.

### 3.2 The exact callsites

- **Generate joint angles + articulated mesh**:
  - `nnutils/urdf_utils.py:309` to `nnutils/urdf_utils.py:323`
  - `visualize_joints()` → `articulate_robot()`

- **Export robot_rest OBJ**:
  - `nnutils/train_utils.py:765` to `nnutils/train_utils.py:772`
  - It writes `robot_rest-<epoch>.obj` into the log directory.

The README documents the CLI entry point:
```
python scripts/extract_mesh.py \
  --flagfile logdir/cat76/opts.log \
  --seqname cat76 \
  --model_path logdir/cat76/params_latest.pth \
  --test_frames 1 \
  --nolineload \
  --pre_skel wolf_mod_revised
```
This triggers the evaluation path that saves `robot_rest-999.obj`.

See:
- `README.md:120` to `README.md:130`
- `nnutils/train_utils.py:765` to `nnutils/train_utils.py:772`
- `nnutils/urdf_utils.py:522` to `nnutils/urdf_utils.py:560`


## 4) Summary (one‑paragraph)

In RAC, the “template URDF” is the predefined skeleton selected by `--pre_skel` (e.g., `wolf_mod_revised.urdf`).  
It defines the kinematic tree, joint axes/origins, and link geometry.  
RAC loads it through `URDFRobot`, extracts joint centers and angle order, and sets template‑specific defaults like `sim3`.  
When exporting `robot_rest`, RAC predicts rest angles, performs URDF FK to articulate the link meshes (`articulate_robot`), applies the template’s Sim(3) transform, and finally exports the mesh as `robot_rest-*.obj`.
